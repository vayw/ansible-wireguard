---
# tasks file for wireguard
- name: system configuration
  tags: system
  block:
    - name: install wireguard tools
      ansible.builtin.dnf:
        name: wireguard-tools
        state: latest

- name: network connection
  block:
    - name: network manager configuration
      template:
        src: wireguard.conf.j2
        dest: "{{ wireguard_nm_connections_folder }}/{{ wireguard_iface }}.nmconnection"
        owner: root
        group: root
        mode: 0600
        force: yes
      register: nmconnection

    - name: reload connection
      ansible.builtin.command: "nmcli c reload"
      when: nmconnection.changed
    - name: reapply config to interface
      ansible.builtin.command: "nmcli d reapply {{ wireguard_iface }}"
      when: nmconnection.changed

- name: netfiler and ip forwarding configuration
  block:
    - name: Enable packet forwarding for IPv4
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
        sysctl_set: yes
        state: present
        reload: yes

    - name: Add WireGuard as a service to FirewallD
      template:
        src: firewalld.xml.j2
        dest: /etc/firewalld/services/wireguard.xml
        owner: root
        group: root
        mode: 0600
      register: firewalld_service

    - name: Reload firewalld to add/update wireguard service
      ansible.builtin.command: "firewall-cmd --reload"
      when: firewalld_service.changed

    - name: Allow WireGuard service for FirewallD zone
      firewalld:
        zone: "{{ wireguard_firewalld_service_zone }}"
        service: wireguard
        state: enabled
        permanent: yes
        immediate: yes

    - name: Add WireGuard interface to FirewallD zone
      firewalld:
        zone: "{{ wireguard_firewalld_zone }}"
        interface: "{{ wireguard_iface }}"
        state: enabled
        permanent: yes
        immediate: yes

    - name: Enable Masquerading
      firewalld:
        zone: "{{ wireguard_firewalld_service_zone }}"
        masquerade: yes
        state: enabled
        permanent: yes
        immediate: yes

    - name: Enable Masquerading for internal zone
      firewalld:
        zone: "{{ wireguard_firewalld_zone }}"
        masquerade: yes
        state: enabled
        permanent: yes
        immediate: yes
